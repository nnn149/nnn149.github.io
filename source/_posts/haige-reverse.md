---
title: 海哥逆向笔记
comments: true
tags:
  - 寄存器
  - 汇编
  - X64dbg
categories:
  - 逆向
date: 2021-10-3 22:33:05
updated:
---

海哥逆向学习笔记记录

<!--more-->

# 工具软件下载

调试

- [x64dbg](https://github.com/x64dbg/x64dbg)



# 基础

## 寄存器

[图文详解通俗易懂的汇编语言寄存器_汇编语言_脚本之家](https://www.jb51.net/article/230062.htm)

[32位CPU寄存器常用知识汇总_ronnie88597的博客-CSDN博客_32位寄存器有哪些](https://blog.csdn.net/weixin_46222091/article/details/109205298)

![image-20220806202642275](haige-reverse/image-20220806202642275.png)

### 通用寄存器

`AX(Accumulator Register)` ： 累加寄存器，它主要用于输入/输出和大规模的指令运算

`CX(Count Register)`：计数寄存器，CX 寄存器在迭代的操作中会循环计数

`DX(data Register)`：数据寄存器，它也用于输入/输出操作。它还与 AX 寄存器以及 DX 一起使用，用于涉及大数值的乘法和除法运

`BX(Base Register)`：基址寄存器，用来存储基础访问地址

算

除了上面 AX、BX、CX、DX 寄存器以外，其他寄存器均不可以分为两个独立的 8 位寄存器

### 索引寄存器

索引寄存器主要包含段地址的偏移量，索引寄存器主要分为

`BP(Base Pointer)`：基础指针，它是栈寄存器上的偏移量，用来定位栈上变量，**栈底**

`SP(Stack Pointer)`: 栈指针，它是栈寄存器上的偏移量，用来定位**栈顶**

`SI(Source Index)`: 变址寄存器，用来拷贝源字符串

`DI(Destination Index)`: 目标变址寄存器，用来复制到目标字符串



### 状态和控制寄存器

就剩下两种寄存器还没聊了，这两种寄存器是指令指针寄存器和标志寄存器：

`IP(Instruction Pointer)`： 指令指针寄存器，它是从 Code Segment 代码寄存器处的偏移来存储执行的下一条指令

`FLAG` : Flag 寄存器用于存储当前进程的状态，这些状态有

- 位置 (Direction)：用于数据块的传输方向，是向上传输还是向下传输
- 中断标志位 (Interrupt) ：1 - 允许；0 - 禁止
- 陷入位 (Trap) ：确定每条指令执行完成后，CPU 是否应该停止。1 - 开启，0 - 关闭
- 进位 (Carry) : 设置最后一个无符号算术运算是否带有进位
- 溢出 (Overflow) : 设置最后一个有符号运算是否溢出
- 符号 (Sign) : 如果最后一次算术运算为负，则设置 1 =负，0 =正
- 零位 (Zero) : 如果最后一次算术运算结果为零，1 = 零
- 辅助进位 (Aux Carry) ：用于第三位到第四位的进位
- 奇偶校验 (Parity) : 用于奇偶校验



## 内存

常用计量单位

**BYTE**(字节) = 8位(BIT)  `0XFF`

**WORD**(字) = 16位(BIT) `0XFFFF`

**DWORD**(双字) = 32位(BIT) `0XFFFFFFFF`

每个内存单元的宽度为8位，[编号]称为地址(加上中括号)

### 寻址公式

- [立即数]
- [reg] reg代表寄存器
- [reg+立即数]
- [reg+reg*(1,2,4,8)]
- [reg+reg*(1,2,4,8)+立即数]

​	

## 堆栈

Windows分配栈时：栈底高地址，栈头低地址

### 堆栈汇编指令

- **PUSH** 入栈
  - push立即数(32位)，栈顶-4
  - push寄存器16位(栈顶-2)，32位，不允许8位
  - push内存，同样不允许8位
- **POP** 出栈
  - 栈顶+4或+2
  - 同push规则，不允许8位
- PUSHAD
  - 把8个通用寄存器的值保存到堆栈，然后就可以随意使用寄存器（保存现场）
- POPAD
  - 恢复8个寄存器的值



## 汇编指令

- **MOV** 目标操作数，源操作数。作用：拷贝源操作数到目标操作数

  - 从指定内存中写入/读取数据
    - `mov dword ptr ds:[0x0012FF34],0x12345678`
      - dword ：要读/写多少 此时是4字节  byte == 1字节 word == 2字节 dword == 4字节
      - ptr: Point 代表后面是一个指针  (指针的意思就是里面存的不是普通的值，而是个地址)
      - ds：段寄存器 先不用管 记住就行

- **LEA** 获取内存地址

  - 例如想获取一个内存地址，其实无法使用 `mov eax,eax-4` 这种写法
  - 可以写成 `lea eax,dword ptr ds:[eax-4]`
  - 等同于 `sub eax,4`

- **ADD** 加

- **SUB** 减

- **AND** 与

- **OR** 或

- **XOR**  异或
  - 源操作数可以是立即数、通用寄存器、段寄存器、或者内存单元
  - 目标操作数可以是通用寄存器、段寄存器或者内存单元
  - 操作数的**宽度**必须一样
  - 源操作数和目标操作数不能同时为内存单元

- **NOT** 非 只有一个操作数

  

## X64DBG

导出修改过的文件，菜单 文件-补丁(`ctrl+P` )，再点击修补文件

### 断点

- 左下方命令窗口输入 `bp MessageBoxA`
- 反汇编窗口选中一行按`F2`开关断点
- 断点窗口选中一行按空格 开关断点

在堆栈窗口选一行按Enter，可以在反汇编中转到指定Dword，一般栈顶保存到是函数的返回地址
